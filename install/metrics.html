

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Metrics &mdash; Ichnaea 2.0 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="Ichnaea 2.0 documentation" href="../index.html"/>
        <link rel="up" title="Installation" href="index.html"/>
        <link rel="next" title="Testing" href="testing.html"/>
        <link rel="prev" title="Configuration" href="config.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> Ichnaea
          

          
          </a>

          
            
            
              <div class="version">
                2.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../usage.html">Using the Service</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/index.html">Services API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../import_export.html">Data Export</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Installation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="devel.html">Development</a></li>
<li class="toctree-l2"><a class="reference internal" href="deploy.html">Deployment</a></li>
<li class="toctree-l2"><a class="reference internal" href="config.html">Configuration</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Metrics</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#api-request-metrics">API Request Metrics</a></li>
<li class="toctree-l3"><a class="reference internal" href="#api-user-metrics">API User Metrics</a></li>
<li class="toctree-l3"><a class="reference internal" href="#api-query-metrics">API Query Metrics</a></li>
<li class="toctree-l3"><a class="reference internal" href="#api-result-metrics">API Result Metrics</a></li>
<li class="toctree-l3"><a class="reference internal" href="#api-source-metrics">API Source Metrics</a></li>
<li class="toctree-l3"><a class="reference internal" href="#api-fallback-source-metrics">API Fallback Source Metrics</a></li>
<li class="toctree-l3"><a class="reference internal" href="#data-pipeline-metrics">Data Pipeline Metrics</a></li>
<li class="toctree-l3"><a class="reference internal" href="#data-pipeline-export-metrics">Data Pipeline Export Metrics</a></li>
<li class="toctree-l3"><a class="reference internal" href="#internal-monitoring">Internal Monitoring</a></li>
<li class="toctree-l3"><a class="reference internal" href="#http-counters">HTTP Counters</a></li>
<li class="toctree-l3"><a class="reference internal" href="#http-timers">HTTP Timers</a></li>
<li class="toctree-l3"><a class="reference internal" href="#task-timers">Task Timers</a></li>
<li class="toctree-l3"><a class="reference internal" href="#datamaps-timers">Datamaps Timers</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="testing.html">Testing</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../algo/index.html">Algorithms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../internal_api/index.html">Internal Code API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changes/index.html">Changelog</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">Ichnaea</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
          <li><a href="index.html">Installation</a> &raquo;</li>
      
    <li>Metrics</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/install/metrics.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="metrics">
<span id="id1"></span><h1>Metrics<a class="headerlink" href="#metrics" title="Permalink to this headline">¶</a></h1>
<p>As discussed in <a class="reference internal" href="deploy.html#deploy"><span class="std std-ref">the deployment document</span></a>, Ichnaea emits
metrics through the Statsd client library with the intent of
aggregating and viewing them on a compatible dashboard.</p>
<p>This document describes the metrics collected.</p>
<p>The code emits most metrics using the statsd tags extension. A metric
name of <code class="docutils literal"><span class="pre">task#name:function,version:old</span></code> therefor means a statsd metric
called <code class="docutils literal"><span class="pre">task</span></code> will be emitted with two tags <code class="docutils literal"><span class="pre">name:function</span></code> and
<code class="docutils literal"><span class="pre">version:old</span></code>.</p>
<div class="section" id="api-request-metrics">
<h2>API Request Metrics<a class="headerlink" href="#api-request-metrics" title="Permalink to this headline">¶</a></h2>
<p>These are metrics that track how many times each specific public API
is used and which clients identified by their API keys do so. They are
grouped by the type of the API, where type is one of <cite>locate</cite>, <cite>region</cite>
and <cite>submit</cite>, independent of the specific version of that API.</p>
<p>These metrics can help in deciding when to remove a deprecated API.</p>
<p><code class="docutils literal"><span class="pre">locate.request#path:v1.search,key:&lt;apikey&gt;</span></code>,
<code class="docutils literal"><span class="pre">locate.request#path:v1.geolocate,key:&lt;apikey&gt;</span></code>,
<code class="docutils literal"><span class="pre">region.request#path:v1.country,key:&lt;apikey&gt;</span></code>,
<code class="docutils literal"><span class="pre">submit.request#path:v1.submit,key:&lt;apikey&gt;</span></code>,
<code class="docutils literal"><span class="pre">submit.request#path:v1.geosubmit,key:&lt;apikey&gt;</span></code>,
<code class="docutils literal"><span class="pre">submit.request#path:v2.geosubmit,key:&lt;apikey&gt;</span></code> : counters</p>
<blockquote>
<div><p>These metrics count how many times a specific API was called by a
specific API key expressed via the API keys short name. The API key
is the actual API key, often a UUID.</p>
<p>Two special short names exist for tracking invalid (<code class="docutils literal"><span class="pre">invalid</span></code>)
and no (<code class="docutils literal"><span class="pre">none</span></code>) provided API keys.</p>
</div></blockquote>
</div>
<div class="section" id="api-user-metrics">
<h2>API User Metrics<a class="headerlink" href="#api-user-metrics" title="Permalink to this headline">¶</a></h2>
<p>For all API requests including the submit-type APIs we gather metrics
about the number of unique users based on the users IP addresses.</p>
<p>These metrics are gathered under the metric prefix:</p>
<p><code class="docutils literal"><span class="pre">&lt;api_type&gt;.user#key&lt;apikey&gt;</span></code> : gauge</p>
<p>They have an additional tag to determine the time interval for which
the unique users are aggregated for:</p>
<p><code class="docutils literal"><span class="pre">#interval:1d</span></code>, <code class="docutils literal"><span class="pre">interval:7d</span></code> : tags</p>
<blockquote>
<div>Unique users per day or last 7 days.</div></blockquote>
<p>Technically these metrics are based on HyperLogLog cardinality numbers
maintained in a Redis service. They should be accurate to about 1% of
the actual number.</p>
</div>
<div class="section" id="api-query-metrics">
<h2>API Query Metrics<a class="headerlink" href="#api-query-metrics" title="Permalink to this headline">¶</a></h2>
<p>For each incoming API query we log metrics about the data contained in
the query with the metric name and tags:</p>
<p><code class="docutils literal"><span class="pre">&lt;api_type&gt;.query#key&lt;apikey&gt;,region:&lt;region_code&gt;</span></code> : counter</p>
<p><cite>api_type</cite> describes the type of API being used, independent of the
version number of the API. So <cite>v1/country</cite> gets logged as <cite>region</cite>
and both <cite>v1/search</cite> and <cite>v1/geolocate</cite> get logged as <cite>locate</cite>.</p>
<p><cite>region_code</cite> is either a two-letter GENC region code like <cite>de</cite> or the
special value <cite>none</cite> if the region of origin of the incoming request
could not be determined.</p>
<p>We extend the metric with additional tags based on the data contained
in it:</p>
<p><code class="docutils literal"><span class="pre">#geoip:false</span></code> : tag</p>
<blockquote>
<div>This tag only gets added if there was no valid client IP address
for this query. Since almost all queries contain a client IP address
we usually skip this tag.</div></blockquote>
<p><code class="docutils literal"><span class="pre">#blue:none</span></code>, <code class="docutils literal"><span class="pre">#blue:one</span></code>, <code class="docutils literal"><span class="pre">#blue:many</span></code>,
<code class="docutils literal"><span class="pre">#cell:none</span></code>, <code class="docutils literal"><span class="pre">#cell:one</span></code>, <code class="docutils literal"><span class="pre">#cell:many</span></code>,
<code class="docutils literal"><span class="pre">#wifi:none</span></code>, <code class="docutils literal"><span class="pre">#wifi:one</span></code>, <code class="docutils literal"><span class="pre">#wifi:many</span></code> : tags</p>
<blockquote>
<div>If the query contained any Bluetooth, cell or WiFi networks,
one blue, cell and wifi tag get added. The tags depend on the
number of valid <a class="reference internal" href="../glossary.html#term-stations"><span class="xref std std-term">stations</span></a> for each of the three.</div></blockquote>
</div>
<div class="section" id="api-result-metrics">
<h2>API Result Metrics<a class="headerlink" href="#api-result-metrics" title="Permalink to this headline">¶</a></h2>
<p>Similar to the API query metrics we also collect metrics about each
result of an API query. This follows the same per API type and per
region rules under the prefix / tag combination:</p>
<p><code class="docutils literal"><span class="pre">&lt;api_type&gt;.result#key:&lt;apikey&gt;,region:&lt;region_code&gt;</span></code></p>
<p>The result metrics measure if we satisfied the incoming API query in
the best possible fashion. Incoming queries can generally contain
an IP address, Bluetooth, cell, WiFi networks or any combination thereof.
If the query contained only cell networks, we do not expect to get a
high accuracy result, as there is too little data in the query to do so.</p>
<p>We express this by classifying each incoming query into one of four
categories:</p>
<dl class="docutils">
<dt>High Accuracy (<code class="docutils literal"><span class="pre">#accuracy:high</span></code>)</dt>
<dd>A query containing at least two Bluetooth or WiFi networks.</dd>
<dt>Medium Accuracy (<code class="docutils literal"><span class="pre">#accuracy:medium</span></code>)</dt>
<dd>A query containing neither Bluetooth nor WiFi networks but at
least one cell network.</dd>
<dt>Low Accuracy (<code class="docutils literal"><span class="pre">#accuracy:low</span></code>)</dt>
<dd>A query containing no networks but only the IP address of the client.</dd>
<dt>No Accuracy (<code class="docutils literal"><span class="pre">#accuracy:none</span></code>)</dt>
<dd>A query containing no usable information, for example an IP-only
query that explicitly disables the IP fallback.</dd>
</dl>
<p>A query containing multiple data types gets put into the best possible
category, so for example any query containing cell data will at least
be of medium accuracy.</p>
<p>One we have determined the expected accuracy category for the query, we
compare it to the accuracy category of the result we determined. If we
can deliver an equal or better category we consider the status to be
a <cite>hit</cite>. If we don&#8217;t satisfy the expected category we consider the
result to be a <cite>miss</cite>.</p>
<p>For each result we then log exactly one of the following tag combinations:</p>
<p><code class="docutils literal"><span class="pre">#accuracy:high,status:hit</span></code>, <code class="docutils literal"><span class="pre">#accuracy:high,status:miss</span></code>,
<code class="docutils literal"><span class="pre">#accuracy:medium,status:hit</span></code>, <code class="docutils literal"><span class="pre">#accuracy:medium,status:miss</span></code>,
<code class="docutils literal"><span class="pre">#accuracy:low,status:hit</span></code>, <code class="docutils literal"><span class="pre">#accuracy:low,status:miss</span></code> : tags</p>
<p>We don&#8217;t log metrics for the uncommon case of <code class="docutils literal"><span class="pre">none</span></code> or no expected
accuracy.</p>
<p>One special case exists for cell networks. If we cannot find an exact
cell match, we might fall back to a cell area based estimate. If the
range of the cell area is fairly small we consider this to be a
<code class="docutils literal"><span class="pre">#accuracy:medium,status:hit</span></code>. But if the size of the cell area is
extremely large, in the order of tens of kilometers to hundreds of
kilometers, we consider it to be a <code class="docutils literal"><span class="pre">#accuracy:medium,status:miss</span></code>.</p>
<p>In the past we only collected stats based on whether or not cell based
data was used to answer a cell based query and counted it as a
cell-based success, even if the provided accuracy was really bad.</p>
<p>In addition to the accuracy of the result, we also tag the result
metric with the data source that got used to provide the result,
but only for results that met the expected accuracy.</p>
<p><code class="docutils literal"><span class="pre">#source:&lt;source_name&gt;</span></code> : tag</p>
<p>Data sources can be one of:</p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">internal</span></code></dt>
<dd>Data from our own crowd-sourcing effort.</dd>
<dt><code class="docutils literal"><span class="pre">fallback</span></code></dt>
<dd>Data from the optional external fallback provider.</dd>
<dt><code class="docutils literal"><span class="pre">geoip</span></code></dt>
<dd>Data from a GeoIP database.</dd>
</dl>
<p>And finally we add a tag to state whether or not the query was allowed
to use the fallback source.</p>
<p><code class="docutils literal"><span class="pre">#fallback_allowed:&lt;value&gt;</span></code> : tag</p>
<blockquote>
<div>The value is either <cite>true</cite> or <cite>false</cite>.</div></blockquote>
</div>
<div class="section" id="api-source-metrics">
<h2>API Source Metrics<a class="headerlink" href="#api-source-metrics" title="Permalink to this headline">¶</a></h2>
<p>In addition to the final API result, we also collect metrics about each
individual data source we use to answer queries under the
<code class="docutils literal"><span class="pre">&lt;api_type&gt;.source#key:&lt;apikey&gt;,region:&lt;region_code&gt;</span></code> metric.</p>
<p>Each request may use one or multiple of these sources to deliver a result.
We log the same metrics as mentioned above for the result.</p>
<p>All of this combined might lead to a tagged metric like:</p>
<p><code class="docutils literal"><span class="pre">locate.source#key:test,region:de,source:geoip,accuracy:low,status:hit</span></code></p>
</div>
<div class="section" id="api-fallback-source-metrics">
<h2>API Fallback Source Metrics<a class="headerlink" href="#api-fallback-source-metrics" title="Permalink to this headline">¶</a></h2>
<p>The external fallback source has a couple extra metrics to observe the
performance of outbound network calls and the effectiveness of its cache.</p>
<p><code class="docutils literal"><span class="pre">locate.fallback.cache#status:hit</span></code>,
<code class="docutils literal"><span class="pre">locate.fallback.cache#status:miss</span></code>,
<code class="docutils literal"><span class="pre">locate.fallback.cache#status:bypassed</span></code>,
<code class="docutils literal"><span class="pre">locate.fallback.cache#status:inconsistent</span></code>,
<code class="docutils literal"><span class="pre">locate.fallback.cache#status:failure</span></code> : counter</p>
<blockquote>
<div>Counts the number of hits and misses for the fallback cache. If
the query should not be cached, a <cite>bypassed</cite> status is used.
If the cached values couldn&#8217;t be read, a <cite>failure</cite> status is used.
If the cached values didn&#8217;t agree on a consistent position,
a <cite>inconsistent</cite> status is used.</div></blockquote>
<p><code class="docutils literal"><span class="pre">locate.fallback.lookup#fallback_name:&lt;fallback_name&gt;</span></code> : timer</p>
<blockquote>
<div>Measures the time it takes to do each outbound network request.
The fallback name tag specifies which fallback service is used.</div></blockquote>
<p><code class="docutils literal"><span class="pre">locate.fallback.lookup#fallback_name:&lt;fallback_name&gt;,status:&lt;code&gt;</span></code> : counter</p>
<blockquote>
<div>Counts the HTTP response codes for all outbound requests per named
fallback service. There is one counter per HTTP response code,
for example <cite>200</cite>.</div></blockquote>
</div>
<div class="section" id="data-pipeline-metrics">
<h2>Data Pipeline Metrics<a class="headerlink" href="#data-pipeline-metrics" title="Permalink to this headline">¶</a></h2>
<p>When a batch of reports is accepted at one of the submission API
endpoints, it is decomposed into a number of &#8220;items&#8221; &#8211; wifi or cell
<a class="reference internal" href="../glossary.html#term-observations"><span class="xref std std-term">observations</span></a> &#8211; each of which then works its way through a process of
normalization, consistency-checking and eventually (possibly) integration
into aggregate <a class="reference internal" href="../glossary.html#term-station"><span class="xref std std-term">station</span></a> estimates held in the main database tables.
Along the way several counters measure the steps involved:</p>
<p><code class="docutils literal"><span class="pre">data.batch.upload</span></code>,
<code class="docutils literal"><span class="pre">data.batch.upload#key:&lt;apikey&gt;</span></code> : counters</p>
<blockquote>
<div><p>Counts the number of &#8220;batches&#8221; of <a class="reference internal" href="../glossary.html#term-reports"><span class="xref std std-term">reports</span></a> accepted to the data
processing pipeline by an API endpoint. A batch generally
corresponds to the set of <a class="reference internal" href="../glossary.html#term-reports"><span class="xref std std-term">reports</span></a> uploaded in a single HTTP POST
to one of the submit APIs. In other words this metric counts
&#8220;submissions that make it past coarse-grained checks&#8221; such as API-key
and JSON schema validity checking.</p>
<p>The metric is either emitted per tracked API key, or for everything
else without a key tag.</p>
</div></blockquote>
<p><code class="docutils literal"><span class="pre">data.report.upload</span></code>,
<code class="docutils literal"><span class="pre">data.report.upload#key:&lt;apikey&gt;</span></code> : counters</p>
<blockquote>
<div>Counts the number of <a class="reference internal" href="../glossary.html#term-reports"><span class="xref std std-term">reports</span></a> accepted into the data processing
pipeline. The metric is either emitted per tracked API key, or for
everything else without a key tag.</div></blockquote>
<p><code class="docutils literal"><span class="pre">data.report.drop</span></code>,
<code class="docutils literal"><span class="pre">data.report.drop#key:&lt;apikey&gt;</span></code> : counter</p>
<blockquote>
<div>Count incoming <a class="reference internal" href="../glossary.html#term-reports"><span class="xref std std-term">reports</span></a> that were discarded due to some internal
consistency, range or validity-condition error.</div></blockquote>
<p><code class="docutils literal"><span class="pre">data.observation.upload#type:blue</span></code>,
<code class="docutils literal"><span class="pre">data.observation.upload#type:blue,key:&lt;apikey&gt;</span></code>,
<code class="docutils literal"><span class="pre">data.observation.upload#type:cell</span></code>,
<code class="docutils literal"><span class="pre">data.observation.upload#type:cell,key:&lt;apikey&gt;</span></code>,
<code class="docutils literal"><span class="pre">data.observation.upload#type:wifi</span></code>,
<code class="docutils literal"><span class="pre">data.observation.upload#type:wifi,key:&lt;apikey&gt;</span></code> : counters</p>
<blockquote>
<div><p>Count the number of Bluetooth, cell or WiFi <a class="reference internal" href="../glossary.html#term-observations"><span class="xref std std-term">observations</span></a> entering
the data processing pipeline; before normalization and blocklist processing
have been applied. In other words this metric counts &#8220;total Bluetooth,
cell or WiFi <a class="reference internal" href="../glossary.html#term-observations"><span class="xref std std-term">observations</span></a> inside each submitted batch&#8221;, as each
batch is composed of individual <a class="reference internal" href="../glossary.html#term-observations"><span class="xref std std-term">observations</span></a>.</p>
<p>The metrics are either emitted per tracked API key, or for everything
else without a key tag.</p>
</div></blockquote>
<p><code class="docutils literal"><span class="pre">data.observation.drop#type:blue</span></code>,
<code class="docutils literal"><span class="pre">data.observation.drop#type:blue,key:&lt;apikey&gt;</span></code>,
<code class="docutils literal"><span class="pre">data.observation.drop#type:cell</span></code>,
<code class="docutils literal"><span class="pre">data.observation.drop#type:cell,key:&lt;apikey&gt;</span></code>,
<code class="docutils literal"><span class="pre">data.observation.drop#type:wifi</span></code>
<code class="docutils literal"><span class="pre">data.observation.drop#type:wifi,key:&lt;apikey&gt;</span></code> : counters</p>
<blockquote>
<div>Count incoming Bluetooth, cell or WiFi <a class="reference internal" href="../glossary.html#term-observations"><span class="xref std std-term">observations</span></a> that were
discarded before integration due to some internal consistency, range or
validity-condition error encountered while attempting to normalize the
<a class="reference internal" href="../glossary.html#term-observation"><span class="xref std std-term">observation</span></a>.</div></blockquote>
<p><code class="docutils literal"><span class="pre">data.observation.insert#type:blue</span></code>,
<code class="docutils literal"><span class="pre">data.observation.insert#type:cell</span></code>,
<code class="docutils literal"><span class="pre">data.observation.insert#type:wifi</span></code> : counters</p>
<blockquote>
<div>Count Bluetooth, cell or WiFi <a class="reference internal" href="../glossary.html#term-observations"><span class="xref std std-term">observations</span></a> that are successfully
normalized, integrated and not discarded due to consistency errors.</div></blockquote>
<p><code class="docutils literal"><span class="pre">data.station.blocklist#type:blue</span></code>,
<code class="docutils literal"><span class="pre">data.station.blocklist#type:cell</span></code>,
<code class="docutils literal"><span class="pre">data.station.blocklist#type:wifi</span></code> : counters</p>
<blockquote>
<div>Count any Bluetooth, cell or WiFi network that is blocklisted due to
the acceptance of multiple <a class="reference internal" href="../glossary.html#term-observations"><span class="xref std std-term">observations</span></a> at sufficiently different
locations. In these cases, we decide that the <a class="reference internal" href="../glossary.html#term-station"><span class="xref std std-term">station</span></a> is &#8220;moving&#8221;
(such as a picocell or mobile hotspot on a public transit vehicle) and
blocklist it, to avoid estimating query positions using the
<a class="reference internal" href="../glossary.html#term-station"><span class="xref std std-term">station</span></a>.</div></blockquote>
<p><code class="docutils literal"><span class="pre">data.station.confirm#type:blue</span></code>,
<code class="docutils literal"><span class="pre">data.station.confirm#type:cell</span></code>,
<code class="docutils literal"><span class="pre">data.station.confirm#type:wifi</span></code> : counters</p>
<blockquote>
<div>Count the number of Bluetooth, cell or WiFi <a class="reference internal" href="../glossary.html#term-station"><span class="xref std std-term">station</span></a> that were
successfully confirmed by any type of <a class="reference internal" href="../glossary.html#term-observations"><span class="xref std std-term">observations</span></a>.</div></blockquote>
<p><code class="docutils literal"><span class="pre">data.station.new#type:blue</span></code>,
<code class="docutils literal"><span class="pre">data.station.new#type:cell</span></code>,
<code class="docutils literal"><span class="pre">data.station.new#type:wifi</span></code> : counters</p>
<blockquote>
<div>Count the number of Bluetooth, cell or WiFi <a class="reference internal" href="../glossary.html#term-station"><span class="xref std std-term">station</span></a> that were
discovered for the first time.</div></blockquote>
</div>
<div class="section" id="data-pipeline-export-metrics">
<h2>Data Pipeline Export Metrics<a class="headerlink" href="#data-pipeline-export-metrics" title="Permalink to this headline">¶</a></h2>
<p>Incoming <a class="reference internal" href="../glossary.html#term-reports"><span class="xref std std-term">reports</span></a> can also be sent to a number of different export
targets. We keep metrics about how those individual export targets perform.</p>
<p><code class="docutils literal"><span class="pre">data.export.batch#key:&lt;export_key&gt;</span></code> : counter</p>
<blockquote>
<div>Count the number of batches sent to the export target.</div></blockquote>
<p><code class="docutils literal"><span class="pre">data.export.upload#key:&lt;export_key&gt;</span></code> : timer</p>
<blockquote>
<div>Track how long the upload operation took per export target.</div></blockquote>
<p><code class="docutils literal"><span class="pre">data.export.upload#key:&lt;export_key&gt;,status:&lt;status&gt;</span></code> : counter</p>
<blockquote>
<div>Track the upload status of the current job. One counter per status.
A status can either be a simple <cite>success</cite> and <cite>failure</cite> or a HTTP
response code like 200, 400, etc.</div></blockquote>
</div>
<div class="section" id="internal-monitoring">
<h2>Internal Monitoring<a class="headerlink" href="#internal-monitoring" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal"><span class="pre">api.limit#key:&lt;apikey&gt;,#path:&lt;path&gt;</span></code> : gauge</p>
<blockquote>
<div>One gauge is created per API key and API path which has rate limiting
enabled on it. This gauge measures how many requests have been done
for each such API key and path combination for the current day.</div></blockquote>
<p><code class="docutils literal"><span class="pre">queue#queue:celery_blue</span></code>,
<code class="docutils literal"><span class="pre">queue#queue:celery_cell</span></code>,
<code class="docutils literal"><span class="pre">queue#queue:celery_default</span></code>,
<code class="docutils literal"><span class="pre">queue#queue:celery_export</span></code>,
<code class="docutils literal"><span class="pre">queue#queue:celery_incoming</span></code>,
<code class="docutils literal"><span class="pre">queue#queue:celery_monitor</span></code>,
<code class="docutils literal"><span class="pre">queue#queue:celery_reports</span></code>,
<code class="docutils literal"><span class="pre">queue#queue:celery_wifi</span></code> : gauges</p>
<blockquote>
<div>These gauges measure the number of tasks in each of the Redis queues.
They are sampled at an approximate per-minute interval.</div></blockquote>
<p><code class="docutils literal"><span class="pre">queue#queue:update_blue_0</span></code>,
<code class="docutils literal"><span class="pre">queue#queue:update_blue_f</span></code>,
<code class="docutils literal"><span class="pre">queue#queue:update_cell_gsm</span></code>,
<code class="docutils literal"><span class="pre">queue#queue:update_cell_wcdma</span></code>,
<code class="docutils literal"><span class="pre">queue#queue:update_cell_lte</span></code>,
<code class="docutils literal"><span class="pre">queue#queue:update_cellarea</span></code>,
<code class="docutils literal"><span class="pre">queue#queue:update_datamap_ne</span></code>,
<code class="docutils literal"><span class="pre">queue#queue:update_datamap_nw</span></code>,
<code class="docutils literal"><span class="pre">queue#queue:update_datamap_se</span></code>,
<code class="docutils literal"><span class="pre">queue#queue:update_datamap_sw</span></code>,
<code class="docutils literal"><span class="pre">queue#queue:update_wifi_0</span></code>,
<code class="docutils literal"><span class="pre">queue#queue:update_wifi_f</span></code> : gauges</p>
<blockquote>
<div>These gauges measure the number of items in the Redis update queues.</div></blockquote>
</div>
<div class="section" id="http-counters">
<h2>HTTP Counters<a class="headerlink" href="#http-counters" title="Permalink to this headline">¶</a></h2>
<p>Every legitimate, routed request to an API endpoint or to a content
view increments a <code class="docutils literal"><span class="pre">request#path:&lt;path&gt;,method:&lt;method&gt;,status:&lt;code&gt;</span></code>
counter.</p>
<p>The path of the counter is the based on the path of the HTTP
request, with slashes replaced with periods. The method tag contains
the lowercased HTTP method of the request. The status tag contains
the response code produced by the request.</p>
<p>For example, a GET of <code class="docutils literal"><span class="pre">/stats/regions</span></code> that results in an HTTP 200
status code, will increment the counter
<code class="docutils literal"><span class="pre">request#path:stats.regions,method:get,status:200</span></code>.</p>
<p>Response codes in the 400 range (eg. 404) are only generated for HTTP
paths referring to API endpoints. Logging them for unknown and invalid
paths would overwhelm the system with all the random paths the friendly
Internet bot army sends along.</p>
</div>
<div class="section" id="http-timers">
<h2>HTTP Timers<a class="headerlink" href="#http-timers" title="Permalink to this headline">¶</a></h2>
<p>In addition to the HTTP counters, every legitimate, routed request
emits a <code class="docutils literal"><span class="pre">request#path:&lt;path&gt;,method:&lt;method&gt;</span></code> timer.</p>
<p>These timers have the same structure as the HTTP counters, except they
do not have the response code tag.</p>
</div>
<div class="section" id="task-timers">
<h2>Task Timers<a class="headerlink" href="#task-timers" title="Permalink to this headline">¶</a></h2>
<p>Our data ingress and data maintenance actions are managed by a Celery
queue of tasks. These tasks are executed asynchronously, and each task
emits a timer indicating its execution time.</p>
<p>For example:</p>
<blockquote>
<div><ul class="simple">
<li><code class="docutils literal"><span class="pre">task#task:data.export_reports</span></code></li>
<li><code class="docutils literal"><span class="pre">task#task:data.update_statcounter</span></code></li>
</ul>
</div></blockquote>
</div>
<div class="section" id="datamaps-timers">
<h2>Datamaps Timers<a class="headerlink" href="#datamaps-timers" title="Permalink to this headline">¶</a></h2>
<p>We include a script to generate a data map from the gathered map
statistics. This script includes a number of timers and pseudo-timers
to monitor its operation.</p>
<p><code class="docutils literal"><span class="pre">datamaps#func:export</span></code>,
<code class="docutils literal"><span class="pre">datamaps#func:encode</span></code>,
<code class="docutils literal"><span class="pre">datamaps#func:merge</span></code>,
<code class="docutils literal"><span class="pre">datamaps#func:main</span></code>,
<code class="docutils literal"><span class="pre">datamaps#func:render</span></code>,
<code class="docutils literal"><span class="pre">datamaps#func:upload</span></code> : timers</p>
<blockquote>
<div>These timers track the individual functions of the generation process.</div></blockquote>
<p><code class="docutils literal"><span class="pre">datamaps#count:csv_rows</span></code>,
<code class="docutils literal"><span class="pre">datamaps#count:quadtrees</span></code>,
<code class="docutils literal"><span class="pre">datamaps#count:tile_new</span></code>,
<code class="docutils literal"><span class="pre">datamaps#count:tile_changed</span></code>,
<code class="docutils literal"><span class="pre">datamaps#count:tile_deleted</span></code>,
<code class="docutils literal"><span class="pre">datamaps#count:tile_unchanged</span></code> : timers</p>
<blockquote>
<div>Pseudo-timers to track the number of CSV rows, Quadtree files and
image tiles.</div></blockquote>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="testing.html" class="btn btn-neutral float-right" title="Testing" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="config.html" class="btn btn-neutral" title="Configuration" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2013-2016, Mozilla.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'2.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>